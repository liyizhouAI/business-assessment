<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI系统管理后台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            min-height: 300px;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .model-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .model-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .model-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .model-card.active {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .model-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .model-desc {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .model-price {
            color: #28a745;
            font-weight: 600;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .prompt-preview {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .prompt-preview h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .prompt-preview pre {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 AI系统管理后台</h1>
            <p>管理Prompt模板、切换AI模型、查看使用统计</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('prompt')">Prompt管理</button>
            <button class="tab" onclick="switchTab('model')">模型配置</button>
            <button class="tab" onclick="switchTab('stats')">使用统计</button>
            <button class="tab" onclick="switchTab('test')">测试中心</button>
        </div>

        <!-- Prompt管理 -->
        <div class="tab-content active" id="prompt-tab">
            <div class="alert alert-info">
                <strong>提示：</strong> 修改Prompt后将立即生效，建议先在测试中心验证效果。
            </div>

            <div class="form-group">
                <label class="form-label">李一舟3.0风格Prompt模板</label>
                <textarea class="form-input form-textarea" id="prompt-template" placeholder="请输入你的Prompt模板...">你是李一舟3.0，一个专业的商业分析师。请根据以下用户数据生成商业项目定位分析报告：

用户信息：
- 姓名：{name}
- 行业：{industry}
- 项目阶段：{stage}
- 项目描述：{description}
- 目标用户：{target_audience}

评分数据：
- 流量维度：{traffic_score}/30分
- 运营维度：{operation_score}/30分
- 服务维度：{service_score}/30分
- 个人喜好：{preference_score}/10分
- 总分：{final_score}/100分

请按照以下格式生成报告：

# 【李一舟3.0】项目诊断报告

## 🎯 核心判断

**底层逻辑是**，...

**讲白了就是**，...

## 📊 深度解析

[详细分析项目定位、商业模式、运营效率、服务体验等]

## ⚡ 行动清单

### 🔥 30天冲刺
[具体可执行的行动步骤]

### 📈 60天优化
[中期优化建议]

### 🚀 90天验证
[长期验证目标]

## 💡 心法提醒

[总结性建议，体现李一舟的风格]

请用李一舟的语言风格，要有"底层逻辑"、"讲白了就是"这样的口头禅，给出实用的商业建议。</textarea>
                <div class="form-hint">
                    <span>支持变量：{name}, {industry}, {stage}, {description}, {target_audience}, {traffic_score}, {operation_score}, {service_score}, {preference_score}, {final_score}</span>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">系统指令（System Prompt）</label>
                <textarea class="form-input" id="system-prompt" placeholder="系统级别的指令...">你是李一舟3.0，一个专业的商业分析师和创业导师。你需要：
1. 用专业但接地气的语言进行分析
2. 经常使用"底层逻辑"、"讲白了就是"等口头禅
3. 给出具体可执行的建议
4. 保持客观但有态度的分析风格
5. 结合当前商业环境和趋势</textarea>
            </div>

            <div class="btn-group">
                <button class="btn" onclick="savePrompt()">保存Prompt</button>
                <button class="btn btn-secondary" onclick="resetPrompt()">重置为默认</button>
                <button class="btn btn-success" onclick="previewPrompt()">预览效果</button>
            </div>

            <div class="prompt-preview" id="prompt-preview" style="display: none;">
                <h4>📝 Prompt预览</h4>
                <pre id="prompt-preview-content"></pre>
            </div>
        </div>

        <!-- 模型配置 -->
        <div class="tab-content" id="model-tab">
            <div class="alert alert-info">
                <strong>当前模型：</strong> <span id="current-model">本地模板生成</span>
            </div>

            <div class="form-group">
                <label class="form-label">选择AI模型</label>
                <div class="model-selector">
                    <div class="model-card active" onclick="selectModel('local')">
                        <div class="model-name">本地模板</div>
                        <div class="model-desc">使用预定义模板生成报告，响应快速，无API费用</div>
                        <div class="model-price">免费</div>
                    </div>
                    <div class="model-card" onclick="selectModel('deepseek')">
                        <div class="model-name">DeepSeek</div>
                        <div class="model-desc">性价比最高的国产大模型，质量好价格便宜</div>
                        <div class="model-price">￥0.001/1K tokens</div>
                    </div>
                    <div class="model-card" onclick="selectModel('openai')">
                        <div class="model-name">OpenAI GPT-4</div>
                        <div class="model-desc">最先进的语言模型，分析质量最高</div>
                        <div class="model-price">$0.03/1K tokens</div>
                    </div>
                    <div class="model-card" onclick="selectModel('claude')">
                        <div class="model-name">Claude 3.5 Sonnet</div>
                        <div class="model-desc">Anthropic的先进模型，逻辑性强</div>
                        <div class="model-price">$0.003/1K tokens</div>
                    </div>
                    <div class="model-card" onclick="selectModel('tongyi')">
                        <div class="model-name">通义千问</div>
                        <div class="model-desc">阿里云的大模型，中文理解能力强</div>
                        <div class="model-price">￥0.002/1K tokens</div>
                    </div>
                    <div class="model-card" onclick="selectModel('wenxin')">
                        <div class="model-name">文心一言</div>
                        <div class="model-desc">百度的大模型，商业分析能力强</div>
                        <div class="model-price">￥0.004/1K tokens</div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">API密钥</label>
                <input type="password" class="form-input" id="api-key" placeholder="请输入API密钥...">
            </div>

            <div class="form-group">
                <label class="form-label">API基础URL（可选）</label>
                <input type="url" class="form-input" id="api-base" placeholder="https://api.openai.com/v1">
            </div>

            <div class="btn-group">
                <button class="btn" onclick="saveModelConfig()">保存配置</button>
                <button class="btn btn-success" onclick="testModel()">测试连接</button>
            </div>
        </div>

        <!-- 使用统计 -->
        <div class="tab-content" id="stats-tab">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-users">0</div>
                    <div class="stat-label">总用户数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-reports">0</div>
                    <div class="stat-label">生成报告数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="api-calls">0</div>
                    <div class="stat-label">API调用次数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-cost">¥0</div>
                    <div class="stat-label">总费用</div>
                </div>
            </div>

            <div class="alert alert-info">
                <strong>注意：</strong> 统计数据每小时更新一次，当前显示的是模拟数据。
            </div>
        </div>

        <!-- 测试中心 -->
        <div class="tab-content" id="test-tab">
            <div class="form-group">
                <label class="form-label">测试数据</label>
                <textarea class="form-input" id="test-data" placeholder="请输入测试用的用户数据JSON...">
{
  "name": "张三",
  "industry": "AI从业者",
  "stage": "想法构思阶段",
  "description": "基于AI技术的创新项目，主要面向都市白领群体，提供智能化的商业解决方案...",
  "target_audience": "都市白领",
  "traffic_score": 8,
  "operation_score": 12,
  "service_score": 15,
  "preference_score": 7,
  "final_score": 42
}
                </textarea>
            </div>

            <div class="btn-group">
                <button class="btn" onclick="testGenerate()">生成测试报告</button>
                <button class="btn btn-secondary" onclick="fillTestData()">填充示例数据</button>
            </div>

            <div class="prompt-preview" id="test-result" style="display: none;">
                <h4>📊 测试结果</h4>
                <pre id="test-result-content"></pre>
            </div>
        </div>
    </div>

    <script>
       // 管理员认证
let adminToken = null;

// 登录管理员
async function loginAdmin() {
    const password = prompt('请输入管理员密码：');
    if (!password) return false;
    
    adminToken = password;
    
    // 测试权限
    try {
        const response = await fetch('/api/admin?action=config', {
            headers: {
                'Authorization': `Bearer ${adminToken}`
            }
        });
        
        if (response.ok) {
            return true;
        } else {
            alert('密码错误');
            adminToken = null;
            return false;
        }
    } catch (error) {
        alert('登录失败：' + error.message);
        adminToken = null;
        return false;
    }
}

// 加载配置信息
async function loadConfig() {
    try {
        const response = await fetch('/api/admin?action=config', {
            headers: {
                'Authorization': `Bearer ${adminToken}`
            }
        });
        
        if (response.ok) {
            const config = await response.json();
            
            // 更新界面
            document.getElementById('system-prompt').value = config.systemPrompt;
            document.getElementById('prompt-template').value = config.customPrompt;
            document.getElementById('current-model').textContent = getModelName(config.currentModel);
            
            // 更新模型选择状态
            document.querySelectorAll('.model-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[onclick="selectModel('${config.currentModel}')"]`)?.classList.add('active');
            
            // 更新API密钥状态
            updateAPIKeyStatus(config.hasApiKeys);
            
        } else {
            throw new Error('获取配置失败');
        }
    } catch (error) {
        console.error('加载配置失败:', error);
        showAlert('error', '加载配置失败：' + error.message);
    }
}

// 加载统计数据
async function loadStats() {
    try {
        const response = await fetch('/api/admin?action=stats', {
            headers: {
                'Authorization': `Bearer ${adminToken}`
            }
        });
        
        if (response.ok) {
            const stats = await response.json();
            
            // 更新统计界面
            document.getElementById('total-users').textContent = stats.totalUsers;
            document.getElementById('total-reports').textContent = stats.totalReports;
            document.getElementById('api-calls').textContent = stats.apiCalls;
            document.getElementById('total-cost').textContent = '¥' + stats.totalCost;
            
            // 更新最近活动
            updateRecentActivity(stats.recentActivity);
            
        } else {
            throw new Error('获取统计数据失败');
        }
    } catch (error) {
        console.error('加载统计数据失败:', error);
        showAlert('error', '加载统计数据失败：' + error.message);
    }
}

// 保存Prompt（真正的实现）
async function savePrompt() {
    const systemPrompt = document.getElementById('system-prompt').value;
    const customPrompt = document.getElementById('prompt-template').value;
    
    try {
        const response = await fetch('/api/admin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${adminToken}`
            },
            body: JSON.stringify({
                action: 'save_prompt',
                data: {
                    systemPrompt: systemPrompt,
                    customPrompt: customPrompt
                }
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            showAlert('success', result.message);
        } else {
            const error = await response.json();
            throw new Error(error.error || '保存失败');
        }
    } catch (error) {
        console.error('保存Prompt失败:', error);
        showAlert('error', '保存Prompt失败：' + error.message);
    }
}

// 测试模型连接（真正的实现）
async function testModel() {
    const currentModel = getCurrentSelectedModel();
    
    try {
        showAlert('info', '正在测试模型连接...');
        
        const response = await fetch(`/api/admin?action=test&model=${currentModel}`, {
            headers: {
                'Authorization': `Bearer ${adminToken}`
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success) {
                showAlert('success', result.message);
            } else {
                showAlert('error', result.error);
            }
        } else {
            throw new Error('测试请求失败');
        }
    } catch (error) {
        console.error('测试模型连接失败:', error);
        showAlert('error', '测试模型连接失败：' + error.message);
    }
}

// 测试报告生成（真正的实现）
async function testGenerate() {
    const testDataText = document.getElementById('test-data').value;
    
    try {
        const userData = JSON.parse(testDataText);
        
        showAlert('info', '正在生成测试报告...');
        
        const response = await fetch('/api/admin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${adminToken}`
            },
            body: JSON.stringify({
                action: 'test_generate',
                data: userData
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success) {
                document.getElementById('test-result-content').textContent = result.report;
                document.getElementById('test-result').style.display = 'block';
                showAlert('success', '测试报告生成成功');
            } else {
                throw new Error(result.error);
            }
        } else {
            throw new Error('生成测试报告失败');
        }
    } catch (error) {
        console.error('测试报告生成失败:', error);
        showAlert('error', '测试报告生成失败：' + error.message);
    }
}

// 显示提示信息
function showAlert(type, message) {
    // 移除现有提示
    const existingAlert = document.querySelector('.alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    // 创建新提示
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    
    // 插入到当前标签页的顶部
    const activeTab = document.querySelector('.tab-content.active');
    if (activeTab) {
        activeTab.insertBefore(alert, activeTab.firstChild);
    }
    
    // 自动消失
    setTimeout(() => {
        if (alert.parentElement) {
            alert.remove();
        }
    }, 5000);
}

// 获取当前选中的模型
function getCurrentSelectedModel() {
    const activeCard = document.querySelector('.model-card.active');
    if (activeCard) {
        const onclick = activeCard.getAttribute('onclick');
        const match = onclick.match(/selectModel\('(.+?)'\)/);
        return match ? match[1] : 'local';
    }
    return 'local';
}

// 获取模型显示名称
function getModelName(modelKey) {
    const modelNames = {
        'local': '本地模板生成',
        'deepseek': 'DeepSeek',
        'openai': 'OpenAI GPT-4',
        'claude': 'Claude 3.5 Sonnet',
        'tongyi': '通义千问',
        'wenxin': '文心一言'
    };
    return modelNames[modelKey] || '未知模型';
}

// 更新API密钥状态
function updateAPIKeyStatus(hasApiKeys) {
    const statusMap = {
        'deepseek': hasApiKeys.deepseek,
        'openai': hasApiKeys.openai,
        'claude': hasApiKeys.claude,
        'tongyi': hasApiKeys.tongyi,
        'wenxin': hasApiKeys.wenxin
    };
    
    // 更新模型卡片的状态显示
    Object.keys(statusMap).forEach(model => {
        const card = document.querySelector(`[onclick="selectModel('${model}')"]`);
        if (card) {
            const statusIndicator = card.querySelector('.api-status') || document.createElement('div');
            statusIndicator.className = 'api-status';
            statusIndicator.textContent = statusMap[model] ? '✅ 已配置' : '❌ 未配置';
            
            if (!card.querySelector('.api-status')) {
                card.appendChild(statusIndicator);
            }
        }
    });
}

// 更新最近活动
function updateRecentActivity(activities) {
    // 这里可以创建一个活动列表显示
    console.log('最近活动:', activities);
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', async function() {
    // 先尝试自动登录（如果有保存的token）
    const savedToken = localStorage.getItem('admin_token');
    if (savedToken) {
        adminToken = savedToken;
        
        // 验证token是否有效
        try {
            const response = await fetch('/api/admin?action=config', {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (response.ok) {
                // Token有效，加载数据
                await loadConfig();
                await loadStats();
            } else {
                // Token无效，清除并重新登录
                localStorage.removeItem('admin_token');
                adminToken = null;
                await initializeAdmin();
            }
        } catch (error) {
            await initializeAdmin();
        }
    } else {
        await initializeAdmin();
    }
});

// 初始化管理员界面
async function initializeAdmin() {
    // 显示登录提示
    const loginSuccess = await loginAdmin();
    
    if (loginSuccess) {
        // 保存token
        localStorage.setItem('admin_token', adminToken);
        
        // 加载配置和统计数据
        await loadConfig();
        await loadStats();
        
        showAlert('success', '管理员登录成功');
    } else {
        showAlert('error', '管理员登录失败，某些功能可能不可用');
    }
}

// 重写原有的模拟函数
function saveModelConfig() {
    // 实际上需要在环境变量中配置，这里只是前端状态更新
    showAlert('info', '模型配置保存成功，请在Vercel环境变量中配置API密钥');
}

// 添加API状态样式
const apiStatusCSS = `
.api-status {
    font-size: 12px;
    margin-top: 8px;
    padding: 4px 8px;
    border-radius: 4px;
    background: #f8f9fa;
    text-align: center;
}
`;

// 添加样式到页面
const style = document.createElement('style');
style.textContent = apiStatusCSS;
document.head.appendChild(style);
    </script>
</body>
</html>
